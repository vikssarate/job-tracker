<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Job Tracker — Multi-Aspirant</title>
<style>
:root{--bg:#0f1220;--card:#161b2b;--ink:#eef1ff;--muted:#9aa3c7;--line:#2a3052;--accent:#6ca8ff;--ok:#7bd88f;--warn:#ffd166;--bad:#ff7575}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
header,footer{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;gap:10px;flex-wrap:wrap}
h1{margin:0;font-size:18px;font-weight:700}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
.panel{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 0 0 1px var(--line)}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,select,button,textarea{padding:9px 10px;border-radius:10px;border:1px solid var(--line);background:#101429;color:var(--ink)}
textarea{min-height:68px;resize:vertical}
button.primary{background:var(--accent);color:#071225;border-color:transparent;font-weight:700}
button.ghost{background:transparent}
button.danger{background:#2a1120;color:#ffd5d5;border-color:#4c1a2d}
.note{color:var(--muted);font-size:12px}
.tabbar{display:flex;gap:8px;flex-wrap:wrap}
.tabbar button{border-radius:999px;padding:6px 10px}
.tabbar button.active{background:var(--accent);color:#071225;border-color:transparent}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
.table th{color:var(--muted);text-align:left;user-select:none}
.table th.sortable{cursor:pointer}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);color:var(--muted)}
.badge.ok{color:#0b3318;background:#112a19;border-color:#224d2d}
.badge.warn{color:#392a00;background:#2b220f;border-color:#4c3f10}
.badge.bad{color:#3a000c;background:#2a0e12;border-color:#4c1a25}
.hide-sm{display:table-cell}
@media (max-width:800px){ .hide-sm{display:none} }

/* Modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50}
.modal.show{display:flex}
.modal>.box{background:var(--card);border-radius:12px;box-shadow:0 0 0 1px var(--line);padding:14px;max-width:720px;width:96%}
.grid{display:grid;gap:10px}
.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
@media (max-width:680px){ .grid.cols-2{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <h1>Job Tracker — Multi-Aspirant</h1>
  <div class="toolbar">
    <select id="who"></select>
    <input id="q" placeholder="Search title/org/notes…" />
    <select id="statusFilter">
      <option value="">All statuses</option>
      <option>Applied</option><option>Admit Card</option><option>Scheduled</option>
      <option>Written Done</option><option>Result</option><option>Withdrawn</option>
    </select>
    <label class="toolbar"><input type="checkbox" id="upcomingOnly" /> Upcoming only</label>
  </div>
  <div class="toolbar">
    <button id="addBtn" class="primary">+ Add exam</button>
    <button id="reload">Reload data</button>
    <button id="exportCsv">Export CSV</button>
    <button id="exportJson">Export JSON</button>
    <button id="settingsBtn">Settings</button>
    <span class="note" id="countNote"></span>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <!-- quick tabs -->
    <div class="tabbar" id="tabs">
      <button data-status="" class="active">All</button>
      <button data-status="Applied">Applied</button>
      <button data-status="Admit Card">Admit Card</button>
      <button data-status="Scheduled">Scheduled</button>
      <button data-status="Written Done">Written Done</button>
      <button data-status="Result">Result</button>
      <button data-status="Withdrawn">Withdrawn</button>
      <span class="note" id="draftNote" style="margin-left:auto"></span>
    </div>

    <!-- table -->
    <table class="table" id="tbl">
      <thead>
        <tr>
          <th class="sortable" data-key="title">Exam / Post</th>
          <th class="hide-sm sortable" data-key="org">Organization</th>
          <th class="sortable" data-key="appliedOn">Applied</th>
          <th class="sortable" data-key="examOn">Exam</th>
          <th>Due</th>
          <th class="sortable" data-key="status">Status</th>
          <th class="hide-sm">Notes</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<footer>
  <span class="note">Data loads from <code>/data/jobs.json</code>. Add items as drafts, then Export JSON or push to GitHub.</span>
  <span class="note" id="verNote"></span>
</footer>

<!-- Add Exam Modal -->
<div class="modal" id="addModal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">Add exam / job</h3>
      <button class="ghost" id="closeAdd">✕</button>
    </div>
    <div class="grid cols-2">
      <div>
        <label class="note">Aspirant name</label>
        <input id="m_name" placeholder="e.g., Vivek Sarate" />
      </div>
      <div>
        <label class="note">Organization</label>
        <input id="m_org" placeholder="e.g., SSC / IBPS / Railways" />
      </div>
      <div>
        <label class="note">Exam / Post title</label>
        <input id="m_title" placeholder="e.g., SSC JE Civil 2025" />
      </div>
      <div>
        <label class="note">Status</label>
        <select id="m_status">
          <option>Applied</option><option>Admit Card</option><option>Scheduled</option>
          <option>Written Done</option><option>Result</option><option>Withdrawn</option>
        </select>
      </div>
      <div>
        <label class="note">Date applied</label>
        <input type="date" id="m_appliedOn" />
      </div>
      <div>
        <label class="note">Tentative exam date (optional)</label>
        <input type="date" id="m_examOn" />
      </div>
      <div class="grid" style="grid-column:1/-1">
        <label class="note">Notes</label>
        <textarea id="m_notes" placeholder="App ID, centre, fee txn, etc."></textarea>
      </div>
    </div>
    <div class="toolbar" style="margin-top:10px;justify-content:space-between">
      <div class="toolbar">
        <button id="saveDraft" class="primary">Save draft (local)</button>
        <button id="pushGithub">Push drafts to GitHub</button>
      </div>
      <span class="note">Tip: configure repo/token in Settings to push directly.</span>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settingsModal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">GitHub settings (optional)</h3>
      <button class="ghost" id="closeSettings">✕</button>
    </div>
    <div class="grid cols-2">
      <div>
        <label class="note">Owner (user/org)</label>
        <input id="gh_owner" placeholder="vikssarate" />
      </div>
      <div>
        <label class="note">Repo</label>
        <input id="gh_repo" placeholder="vikssarate.github.io" />
      </div>
      <div>
        <label class="note">Branch</label>
        <input id="gh_branch" placeholder="main" />
      </div>
      <div>
        <label class="note">File path</label>
        <input id="gh_path" placeholder="data/jobs.json" />
      </div>
      <div style="grid-column:1/-1">
        <label class="note">Personal Access Token (repo contents: read & write). Stored only in this browser.</label>
        <input id="gh_token" type="password" placeholder="ghp_… or fine-grained token" />
      </div>
    </div>
    <div class="toolbar" style="margin-top:10px;justify-content:space-between">
      <div class="toolbar">
        <button id="saveCfg" class="primary">Save</button>
        <button id="testPush">Test push (no write)</button>
        <button id="clearCfg" class="danger">Clear token</button>
      </div>
      <span class="note">Create token: GitHub → Settings → Developer settings → Personal access tokens.</span>
    </div>
  </div>
</div>

<script>
(function(){
  const DATA_URL_BASE = 'data/jobs.json';

  // DOM
  const rows = $('#rows'), whoSel = $('#who'), q = $('#q'), statusFilter = $('#statusFilter'),
        upcomingOnly = $('#upcomingOnly'), countNote = $('#countNote'), verNote = $('#verNote'),
        tabs = $('#tabs'), exportCsvBtn = $('#exportCsv'), reloadBtn = $('#reload'),
        exportJsonBtn = $('#exportJson'), draftNote = $('#draftNote'),
        addBtn = $('#addBtn'), addModal = $('#addModal'), closeAdd = $('#closeAdd'),
        m = (id)=>$('#'+id), settingsBtn = $('#settingsBtn'), settingsModal = $('#settingsModal'),
        closeSettings = $('#closeSettings');

  // state
  const state = {
    allRemote: [], // as loaded from jobs.json
    all: [],       // remote + drafts (for rendering)
    who: '',
    statusQuick: '',
    sortKey: 'examOn',
    sortDir: 'asc',
    version: '',
    drafts: loadDrafts(),
    cfg: loadCfg()
  };

  // ---------- helpers ----------
  function $(s){ return document.querySelector(s); }
  const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const fmtDate = s => !s ? '—' : new Date(s+'T00:00:00').toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});
  function daysUntil(s){ if(!s) return null; const t0 = new Date(); const d = new Date(s+'T00:00:00'); const today = new Date(t0.getFullYear(), t0.getMonth(), t0.getDate()); return Math.round((d - today)/86400000); }
  function badge(n){ if(n===null) return '<span class="badge">—</span>'; if(n<0) return `<span class="badge bad">${Math.abs(n)}d past</span>`; if(n===0) return `<span class="badge warn">Today</span>`; if(n<=7) return `<span class="badge warn">${n}d</span>`; if(n<=30) return `<span class="badge ok">${n}d</span>`; return `<span class="badge">${n}d</span>`; }
  function cmp(a,b,key){ const av = a[key] ?? '', bv = b[key] ?? ''; if((key==='appliedOn'||key==='examOn')){ if(!av && !bv) return 0; if(!av) return 1; if(!bv) return -1; } return String(av).localeCompare(String(bv), undefined, {numeric:true, sensitivity:'base'}); }
  function uniqueNames(arr){ return Array.from(new Set(arr.map(r => r.name).filter(Boolean))).sort((a,b)=>a.localeCompare(b)); }
  function todayISO(){ const d=new Date(); return d.toISOString().slice(0,10); }
  function b64(s){ return btoa(unescape(encodeURIComponent(s))); }

  // storage
  function loadDrafts(){ try{ return JSON.parse(localStorage.getItem('jt_drafts')||'[]'); }catch{ return []; } }
  function saveDrafts(){ localStorage.setItem('jt_drafts', JSON.stringify(state.drafts)); updateDraftNote(); }
  function loadCfg(){ try{ return JSON.parse(localStorage.getItem('jt_cfg')||'{}'); }catch{ return {}; } }
  function saveCfg(){ localStorage.setItem('jt_cfg', JSON.stringify(state.cfg||{})); }

  // ---------- data load / render ----------
  async function loadData(cacheBust=false){
    const url = cacheBust ? DATA_URL_BASE + '?v=' + Date.now() : DATA_URL_BASE;
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('Failed to load jobs.json');
    const json = await res.json();
    state.allRemote = Array.isArray(json.jobs)? json.jobs : [];
    state.version = json.version || '';
    verNote.textContent = state.version ? ('Data version: ' + state.version) : '';
    composeAll();
    populateWho();
    fromURL();
    render();
  }

  function composeAll(){
    // merge remote + drafts; avoid duplicate identical rows (based on key fields)
    const keyOf = r => [r.name,r.title,r.appliedOn].map(x=>String(x||'').trim().toLowerCase()).join('||');
    const map = new Map();
    state.allRemote.forEach(r=> map.set(keyOf(r), r));
    state.drafts.forEach(d=> map.set(keyOf(d), {...d, _draft:true}));
    state.all = Array.from(map.values());
  }

  function populateWho(){
    const names = uniqueNames(state.all);
    const current = state.who || localStorage.getItem('jt_who') || (new URLSearchParams(location.search).get('who') || '');
    whoSel.innerHTML = '<option value="">— Select aspirant —</option>' + names.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
    if(names.includes(current)) whoSel.value = current;
    state.who = whoSel.value;
  }

  function matches(r){
    if(state.who && r.name !== state.who) return false;
    const statusChosen = state.statusQuick || statusFilter.value;
    if(statusChosen && r.status !== statusChosen) return false;
    if(upcomingOnly.checked){
      const n = daysUntil(r.examOn);
      if(n===null || n<0) return false;
    }
    const term = q.value.trim().toLowerCase();
    if(!term) return true;
    return [r.title,r.org,r.notes].some(v => String(v||'').toLowerCase().includes(term));
  }

  function render(){
    const filtered = state.all.filter(matches).sort((a,b)=> (state.sortDir==='asc'? cmp(a,b,state.sortKey) : -cmp(a,b,state.sortKey)));
    rows.innerHTML = filtered.map(r=>`
      <tr>
        <td><div style="font-weight:600">${esc(r.title)}</div>${r._draft? ' <span class="badge warn">draft</span>':''}<div class="note hide-sm">${esc(r.name||'')}</div></td>
        <td class="hide-sm">${esc(r.org||'')}</td>
        <td>${fmtDate(r.appliedOn)}</td>
        <td>${fmtDate(r.examOn)}</td>
        <td>${badge(daysUntil(r.examOn))}</td>
        <td>${esc(r.status||'')}</td>
        <td class="hide-sm">${esc(r.notes||'')}</td>
      </tr>
    `).join('');
    countNote.textContent = `${filtered.length} shown${state.who? ' for ' + state.who : ''} / ${state.all.length} total`;
    localStorage.setItem('jt_who', state.who || '');
    const usp = new URLSearchParams(location.search);
    if(state.who) usp.set('who', state.who); else usp.delete('who');
    history.replaceState(null, '', location.pathname + (usp.toString()? '?'+usp : ''));
    updateDraftNote();
  }

  function updateDraftNote(){
    const n = state.drafts.length;
    draftNote.textContent = n? `Drafts pending: ${n}` : '';
  }

  // ---------- UI events ----------
  whoSel.addEventListener('change', ()=>{ state.who = whoSel.value; render(); });
  q.addEventListener('input', render);
  statusFilter.addEventListener('change', ()=>{ state.statusQuick=''; setActiveTab(''); render(); });
  upcomingOnly.addEventListener('change', render);
  document.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.getAttribute('data-key');
      if(state.sortKey===key){ state.sortDir = state.sortDir==='asc' ? 'desc' : 'asc'; }
      else { state.sortKey = key; state.sortDir='asc'; }
      render();
    });
  });
  $('#tabs').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const s = btn.getAttribute('data-status') || '';
    state.statusQuick = s;
    statusFilter.value = '';
    setActiveTab(s); render();
  });
  function setActiveTab(s){ $('#tabs').querySelectorAll('button').forEach(b=> b.classList.toggle('active', (b.getAttribute('data-status')||'')===s)); }

  reloadBtn.addEventListener('click', ()=> loadData(true).catch(err=>alert(err.message)));

  exportCsvBtn.addEventListener('click', ()=>{
    const headers = ['name','title','org','appliedOn','examOn','status','notes'];
    const items = state.all.filter(matches);
    const csv = [headers.join(',')].concat(items.map(o => headers.map(h => `"${String(o[h]??'').replace(/"/g,'""')}"`).join(','))).join('\n');
    downloadFile(new Blob([csv], {type:'text/csv'}), (state.who? state.who+'-' : '') + 'jobs.csv');
  });

  exportJsonBtn.addEventListener('click', ()=>{
    const merged = mergeForSave(); // remote + drafts
    const out = JSON.stringify(merged, null, 2);
    downloadFile(new Blob([out], {type:'application/json'}), 'jobs.json');
  });

  // ---------- Add exam modal ----------
  addBtn.addEventListener('click', ()=>{
    show(addModal,true);
    m('m_name').value = state.who || '';
    m('m_title').value = '';
    m('m_org').value = '';
    m('m_status').value = 'Applied';
    m('m_appliedOn').value = todayISO();
    m('m_examOn').value = '';
    m('m_notes').value = '';
    m('m_title').focus();
  });
  closeAdd.addEventListener('click', ()=> show(addModal,false));

  $('#saveDraft').addEventListener('click', ()=>{
    const rec = {
      name: m('m_name').value.trim(),
      title: m('m_title').value.trim(),
      org: m('m_org').value.trim(),
      appliedOn: m('m_appliedOn').value,
      examOn: m('m_examOn').value,
      status: m('m_status').value,
      notes: m('m_notes').value.trim()
    };
    if(!rec.name || !rec.title || !rec.appliedOn){ alert('Please fill Name, Title, and Date applied.'); return; }
    state.drafts.push(rec);
    saveDrafts();
    composeAll(); populateWho(); render();
    show(addModal,false);
  });

  // push to GitHub (from Add modal)
  $('#pushGithub').addEventListener('click', pushDraftsToGitHub);

  // ---------- Settings modal ----------
  settingsBtn.addEventListener('click', ()=>{
    show(settingsModal,true);
    m('gh_owner').value = state.cfg.owner || '';
    m('gh_repo').value = state.cfg.repo || '';
    m('gh_branch').value = state.cfg.branch || 'main';
    m('gh_path').value = state.cfg.path || 'data/jobs.json';
    m('gh_token').value = state.cfg.token || '';
  });
  closeSettings.addEventListener('click', ()=> show(settingsModal,false));

  $('#saveCfg').addEventListener('click', ()=>{
    state.cfg = {
      owner: m('gh_owner').value.trim(),
      repo: m('gh_repo').value.trim(),
      branch: m('gh_branch').value.trim() || 'main',
      path: m('gh_path').value.trim() || 'data/jobs.json',
      token: m('gh_token').value.trim()
    };
    saveCfg();
    alert('Saved. You can now push drafts from the Add modal.');
  });

  $('#clearCfg').addEventListener('click', ()=>{
    state.cfg = { owner:'', repo:'', branch:'', path:'', token:'' };
    saveCfg(); alert('Cleared.');
  });

  $('#testPush').addEventListener('click', async ()=>{
    try{
      const meta = await ghGetFileMeta();
      alert('OK: found file with SHA ' + (meta.sha||''));
    }catch(err){ alert('Check settings/token: '+ err.message); }
  });

  // ---------- GitHub API helpers ----------
  async function pushDraftsToGitHub(){
    if(!(state.cfg && state.cfg.token)){ alert('Add GitHub token in Settings first.'); return; }
    if(!state.drafts.length){ alert('No drafts to push.'); return; }
    try{
      const meta = await ghGetFileMeta(); // includes existing content
      const existing = JSON.parse(decodeURIComponent(escape(atob(meta.content.replace(/\n/g,'')))));
      const merged = mergeForSave(existing); // add drafts
      const contentB64 = b64(JSON.stringify(merged,null,2));
      const res = await fetch(`https://api.github.com/repos/${state.cfg.owner}/${state.cfg.repo}/contents/${state.cfg.path}`,{
        method:'PUT',
        headers:{
          'Authorization':'Bearer '+state.cfg.token,
          'Accept':'application/vnd.github+json'
        },
        body: JSON.stringify({
          message: `Add ${state.drafts.length} job(s) via web app`,
          content: contentB64,
          sha: meta.sha,
          branch: state.cfg.branch
        })
      });
      if(!res.ok){ const t = await res.text(); throw new Error('GitHub write failed: '+t); }
      // clear drafts and reload
      state.drafts = []; saveDrafts();
      await loadData(true);
      show(addModal,false);
      alert('Pushed to GitHub ✔');
    }catch(err){ alert(err.message); }
  }

  function mergeForSave(existing){
    const base = existing || { version:'', jobs: [] };
    const out = { version: new Date().toISOString().slice(0,10), jobs: base.jobs.slice() };
    // append drafts (avoid exact duplicate of name+title+appliedOn)
    const keyOf = r => [r.name,r.title,r.appliedOn].map(x=>String(x||'').trim().toLowerCase()).join('||');
    const set = new Set(out.jobs.map(keyOf));
    state.drafts.forEach(d=>{ const k=keyOf(d); if(!set.has(k)){ out.jobs.push(d); set.add(k); } });
    return out;
  }

  async function ghGetFileMeta(){
    const url = `https://api.github.com/repos/${state.cfg.owner}/${state.cfg.repo}/contents/${state.cfg.path}?ref=${encodeURIComponent(state.cfg.branch||'main')}`;
    const res = await fetch(url, { headers:{ 'Authorization':'Bearer '+state.cfg.token, 'Accept':'application/vnd.github+json' } });
    if(!res.ok) throw new Error('Fetch file failed ('+res.status+').');
    return res.json(); // {sha, content(base64), ...}
  }

  // ---------- utils ----------
  function show(el, on){ el.classList.toggle('show', !!on); }
  function downloadFile(blob, name){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); }
  function fromURL(){ const u=new URLSearchParams(location.search); const who=u.get('who'); if(who){ state.who=who; whoSel.value=who; } }

  // ---------- init ----------
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ show(addModal,false); show(settingsModal,false);} });
  document.querySelectorAll('.modal').forEach(m=> m.addEventListener('click', (e)=>{ if(e.target===m) show(m,false); }));

  loadData().catch(err=>{
    rows.innerHTML = `<tr><td colspan="7">Failed to load data: ${esc(err.message)}. Ensure <code>/data/jobs.json</code> exists.</td></tr>`;
  });
})();
</script>
</body>
</html>
