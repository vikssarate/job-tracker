<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Job Tracker — Multi-Aspirant</title>
<style>
:root{--bg:#0f1220;--card:#161b2b;--ink:#eef1ff;--muted:#9aa3c7;--line:#2a3052;--accent:#6ca8ff;--ok:#7bd88f;--warn:#ffd166;--bad:#ff7575}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
header,footer{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;gap:10px;flex-wrap:wrap}
h1{margin:0;font-size:18px;font-weight:700}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
.panel{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 0 0 1px var(--line)}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,select,button{padding:9px 10px;border-radius:10px;border:1px solid var(--line);background:#101429;color:var(--ink)}
button.primary{background:var(--accent);color:#071225;border-color:transparent;font-weight:700}
button.ghost{background:transparent}
.note{color:var(--muted);font-size:12px}
.tabbar{display:flex;gap:8px;flex-wrap:wrap}
.tabbar button{border-radius:999px;padding:6px 10px}
.tabbar button.active{background:var(--accent);color:#071225;border-color:transparent}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
.table th{color:var(--muted);text-align:left;user-select:none}
.table th.sortable{cursor:pointer}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);color:var(--muted)}
.badge.ok{color:#0b3318;background:#112a19;border-color:#224d2d}
.badge.warn{color:#392a00;background:#2b220f;border-color:#4c3f10}
.badge.bad{color:#3a000c;background:#2a0e12;border-color:#4c1a25}
.hide-sm{display:table-cell}
@media (max-width:800px){ .hide-sm{display:none} }
</style>
</head>
<body>
<header>
  <h1>Job Tracker — Multi-Aspirant</h1>
  <div class="toolbar">
    <select id="who"></select>
    <input id="q" placeholder="Search title/org/notes…" />
    <select id="statusFilter">
      <option value="">All statuses</option>
      <option>Applied</option><option>Admit Card</option><option>Scheduled</option>
      <option>Written Done</option><option>Result</option><option>Withdrawn</option>
    </select>
    <label class="toolbar"><input type="checkbox" id="upcomingOnly" /> Upcoming only</label>
  </div>
  <div class="toolbar">
    <button id="reload" title="Force refresh data (cache-bust)">Reload data</button>
    <button id="exportCsv">Export CSV</button>
    <span class="note" id="countNote"></span>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <!-- Status tabs (quick filters) -->
    <div class="tabbar" id="tabs">
      <button data-status="" class="active">All</button>
      <button data-status="Applied">Applied</button>
      <button data-status="Admit Card">Admit Card</button>
      <button data-status="Scheduled">Scheduled</button>
      <button data-status="Written Done">Written Done</button>
      <button data-status="Result">Result</button>
      <button data-status="Withdrawn">Withdrawn</button>
    </div>

    <!-- Table -->
    <table class="table" id="tbl">
      <thead>
        <tr>
          <th class="sortable" data-key="title">Exam / Post</th>
          <th class="hide-sm sortable" data-key="org">Organization</th>
          <th class="sortable" data-key="appliedOn">Applied</th>
          <th class="sortable" data-key="examOn">Exam</th>
          <th>Due</th>
          <th class="sortable" data-key="status">Status</th>
          <th class="hide-sm">Notes</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<footer>
  <span class="note">Data loads from <code>/data/jobs.json</code> in this repo. Edit it on GitHub to update everyone’s lists.</span>
  <span class="note" id="verNote"></span>
</footer>

<script>
(function(){
  const DATA_URL_BASE = 'data/jobs.json';
  const rows = document.getElementById('rows');
  const whoSel = document.getElementById('who');
  const q = document.getElementById('q');
  const statusFilter = document.getElementById('statusFilter');
  const upcomingOnly = document.getElementById('upcomingOnly');
  const countNote = document.getElementById('countNote');
  const verNote = document.getElementById('verNote');
  const tabs = document.getElementById('tabs');
  const exportBtn = document.getElementById('exportCsv');
  const reloadBtn = document.getElementById('reload');

  const state = {
    all: [],
    who: '',
    statusQuick: '',
    sortKey: 'examOn',
    sortDir: 'asc',
    version: ''
  };

  // helpers
  const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const fmtDate = s => !s ? '—' : new Date(s+'T00:00:00').toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});
  function daysUntil(s){
    if(!s) return null;
    const today = new Date(); const d = new Date(s+'T00:00:00');
    const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    return Math.round((d - t0)/86400000);
  }
  function badge(n){
    if(n===null) return '<span class="badge">—</span>';
    if(n<0) return `<span class="badge bad">${Math.abs(n)}d past</span>`;
    if(n===0) return `<span class="badge warn">Today</span>`;
    if(n<=7) return `<span class="badge warn">${n}d</span>`;
    if(n<=30) return `<span class="badge ok">${n}d</span>`;
    return `<span class="badge">${n}d</span>`;
  }
  function cmp(a,b,key){
    const av = a[key] ?? '', bv = b[key] ?? '';
    if((key==='appliedOn'||key==='examOn')){ if(!av && !bv) return 0; if(!av) return 1; if(!bv) return -1; }
    return String(av).localeCompare(String(bv), undefined, {numeric:true, sensitivity:'base'});
  }

  // load data
  async function loadData(cacheBust=false){
    const url = cacheBust ? DATA_URL_BASE + '?v=' + Date.now() : DATA_URL_BASE;
    const res = await fetch(url, {cache: 'no-store'});
    if(!res.ok) throw new Error('Failed to load jobs.json');
    const json = await res.json();
    state.all = Array.isArray(json.jobs) ? json.jobs : [];
    state.version = json.version || '';
    verNote.textContent = state.version ? ('Data version: ' + state.version) : '';
    populateWho();
    fromURL();
    render();
  }

  function uniqueNames(arr){
    return Array.from(new Set(arr.map(r => r.name).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  }

  function populateWho(){
    const names = uniqueNames(state.all);
    const current = state.who || localStorage.getItem('jt_who') || (new URLSearchParams(location.search).get('who') || '');
    whoSel.innerHTML = '<option value="">— Select aspirant —</option>' + names.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
    if(names.includes(current)) whoSel.value = current;
    state.who = whoSel.value;
  }

  function matches(r){
    // person
    if(state.who && r.name !== state.who) return false;
    // quick tab vs dropdown filter
    const statusChosen = state.statusQuick || statusFilter.value;
    if(statusChosen && r.status !== statusChosen) return false;
    // upcoming
    if(upcomingOnly.checked){
      const n = daysUntil(r.examOn);
      if(n===null || n<0) return false;
    }
    // search
    const term = q.value.trim().toLowerCase();
    if(!term) return true;
    return [r.title,r.org,r.notes].some(v => String(v||'').toLowerCase().includes(term));
  }

  function render(){
    const filtered = state.all.filter(matches).sort((a,b)=>{
      const s = cmp(a,b,state.sortKey);
      return state.sortDir==='asc'? s : -s;
    });
    rows.innerHTML = filtered.map(r=>`
      <tr>
        <td><div style="font-weight:600">${esc(r.title)}</div></td>
        <td class="hide-sm">${esc(r.org||'')}</td>
        <td>${fmtDate(r.appliedOn)}</td>
        <td>${fmtDate(r.examOn)}</td>
        <td>${badge(daysUntil(r.examOn))}</td>
        <td>${esc(r.status||'')}</td>
        <td class="hide-sm">${esc(r.notes||'')}</td>
      </tr>
    `).join('');
    countNote.textContent = `${filtered.length} shown${state.who? ' for ' + state.who : ''} / ${state.all.length} total`;
    localStorage.setItem('jt_who', state.who || '');
    // update URL (?who=Name)
    const usp = new URLSearchParams(location.search);
    if(state.who) usp.set('who', state.who); else usp.delete('who');
    history.replaceState(null, '', location.pathname + (usp.toString()? '?'+usp : ''));
  }

  // events
  whoSel.addEventListener('change', ()=>{ state.who = whoSel.value; render(); });
  q.addEventListener('input', render);
  statusFilter.addEventListener('change', ()=>{ state.statusQuick=''; setActiveTab(''); render(); });

  document.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.getAttribute('data-key');
      if(state.sortKey===key){ state.sortDir = state.sortDir==='asc' ? 'desc' : 'asc'; }
      else { state.sortKey = key; state.sortDir='asc'; }
      render();
    });
  });

  upcomingOnly.addEventListener('change', render);

  tabs.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const s = btn.getAttribute('data-status') || '';
    state.statusQuick = s;
    statusFilter.value = ''; // decouple from dropdown
    setActiveTab(s);
    render();
  });

  function setActiveTab(s){
    tabs.querySelectorAll('button').forEach(b=> b.classList.toggle('active', (b.getAttribute('data-status')||'')===s));
  }

  exportBtn.addEventListener('click', ()=>{
    const headers = ['name','title','org','appliedOn','examOn','status','notes'];
    const items = state.all.filter(matches);
    const csv = [headers.join(',')].concat(items.map(o => headers.map(h => `"${String(o[h]??'').replace(/"/g,'""')}"`).join(','))).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (state.who? state.who+'-' : '') + 'jobs.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  });

  reloadBtn.addEventListener('click', ()=> loadData(true).catch(err=>alert(err.message)));

  function fromURL(){
    const u = new URLSearchParams(location.search);
    const who = u.get('who'); if(who) { state.who = who; whoSel.value = who; }
  }

  // init
  loadData().catch(err=>{
    rows.innerHTML = `<tr><td colspan="7">Failed to load data: ${esc(err.message)}. Ensure <code>/data/jobs.json</code> exists.</td></tr>`;
  });
})();
</script>
</body>
</html>
