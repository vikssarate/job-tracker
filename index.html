<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Job Tracker — Multi-Aspirant</title>
<style>
:root{--bg:#0f1220;--card:#161b2b;--ink:#eef1ff;--muted:#9aa3c7;--line:#2a3052;--accent:#6ca8ff;--ok:#7bd88f;--warn:#ffd166;--bad:#ff7575}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
header,footer{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;gap:10px;flex-wrap:wrap}
h1{margin:0;font-size:18px;font-weight:700}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
.panel{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 0 0 1px var(--line)}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,select,button,textarea{padding:9px 10px;border-radius:10px;border:1px solid var(--line);background:#101429;color:var(--ink)}
textarea{min-height:68px;resize:vertical}
button.primary{background:var(--accent);color:#071225;border-color:transparent;font-weight:700}
button.ghost{background:transparent}
button.danger{background:#2a1120;color:#ffd5d5;border-color:#4c1a2d}
.note{color:var(--muted);font-size:12px}
.tabbar{display:flex;gap:8px;flex-wrap:wrap}
.tabbar button{border-radius:999px;padding:6px 10px}
.tabbar button.active{background:var(--accent);color:#071225;border-color:transparent}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
.table th{color:var(--muted);text-align:left;user-select:none}
.table th.sortable{cursor:pointer}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);color:var(--muted)}
.badge.ok{color:#0b3318;background:#112a19;border-color:#224d2d}
.badge.warn{color:#392a00;background:#2b220f;border-color:#4c3f10}
.badge.bad{color:#3a000c;background:#2a0e12;border-color:#4c1a25}
.actions button{margin-right:6px}
.hide-sm{display:table-cell}
@media (max-width:800px){ .hide-sm{display:none} }

/* Modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50}
.modal.show{display:flex}
.modal>.box{background:var(--card);border-radius:12px;box-shadow:0 0 0 1px var(--line);padding:14px;max-width:720px;width:96%}
.grid{display:grid;gap:10px}
.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
@media (max-width:680px){ .grid.cols-2{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <h1>Job Tracker — Multi-Aspirant</h1>
  <div class="toolbar">
    <select id="who"></select>
    <input id="q" placeholder="Search title/org/notes…" />
    <select id="statusFilter">
      <option value="">All statuses</option>
      <option>Applied</option><option>Admit Card</option><option>Scheduled</option>
      <option>Written Done</option><option>Result</option><option>Withdrawn</option>
    </select>
    <label class="toolbar"><input type="checkbox" id="upcomingOnly" /> Upcoming only</label>
  </div>
  <div class="toolbar">
    <button id="addBtn" class="primary">+ Add exam</button>
    <button id="reload">Reload data</button>
    <button id="exportCsv">Export CSV</button>
    <button id="exportJson">Export JSON</button>
    <button id="exportAsp">Export Aspirants</button>
    <button id="settingsBtn">Settings</button>
    <span class="note" id="countNote"></span>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <div class="tabbar" id="tabs">
      <button data-status="" class="active">All</button>
      <button data-status="Applied">Applied</button>
      <button data-status="Admit Card">Admit Card</button>
      <button data-status="Scheduled">Scheduled</button>
      <button data-status="Written Done">Written Done</button>
      <button data-status="Result">Result</button>
      <button data-status="Withdrawn">Withdrawn</button>
      <span class="note" id="draftNote" style="margin-left:auto"></span>
    </div>

    <table class="table" id="tbl">
      <thead>
        <tr>
          <th class="sortable" data-key="title">Exam / Post</th>
          <th class="hide-sm sortable" data-key="org">Organization</th>
          <th class="sortable" data-key="appliedOn">Applied</th>
          <th class="sortable" data-key="examOn">Exam</th>
          <th>Due</th>
          <th class="sortable" data-key="status">Status</th>
          <th class="hide-sm">Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<footer>
  <span class="note">Data loads from <code>/data/jobs.json</code> and <code>/data/aspirants.json</code>. Local changes can be pushed to GitHub.</span>
  <span class="note" id="verNote"></span>
</footer>

<!-- Add/Edit Job Modal -->
<div class="modal" id="editModal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px" id="modalTitle">Add exam / job</h3>
      <button class="ghost" id="closeEdit">✕</button>
    </div>
    <div class="grid cols-2">
      <div>
        <label class="note">Aspirant name</label>
        <input id="m_name" placeholder="e.g., Vivek Sarate" />
      </div>
      <div>
        <label class="note">Organization</label>
        <input id="m_org" placeholder="e.g., SSC / IBPS / Railways" />
      </div>
      <div>
        <label class="note">Exam / Post title</label>
        <input id="m_title" placeholder="e.g., SSC JE Civil 2025" />
      </div>
      <div>
        <label class="note">Status</label>
        <select id="m_status">
          <option>Applied</option><option>Admit Card</option><option>Scheduled</option>
          <option>Written Done</option><option>Result</option><option>Withdrawn</option>
        </select>
      </div>
      <div>
        <label class="note">Date applied</label>
        <input type="date" id="m_appliedOn" />
      </div>
      <div>
        <label class="note">Tentative exam date (optional)</label>
        <input type="date" id="m_examOn" />
      </div>
      <div class="grid" style="grid-column:1/-1">
        <label class="note">Notes</label>
        <textarea id="m_notes" placeholder="App ID, centre, fee txn, etc."></textarea>
      </div>
    </div>
    <div class="toolbar" style="margin-top:10px;justify-content:space-between">
      <div class="toolbar">
        <button id="saveDraft" class="primary">Save</button>
        <button id="pushGithub">Push changes to GitHub</button>
      </div>
      <span class="note">Configure repo/token in Settings; or use Export JSON/Aspirants.</span>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settingsModal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">GitHub settings (optional)</h3>
      <button class="ghost" id="closeSettings">✕</button>
    </div>
    <div class="grid cols-2">
      <div><label class="note">Owner</label><input id="gh_owner" placeholder="vikssarate" /></div>
      <div><label class="note">Repo</label><input id="gh_repo" placeholder="vikssarate.github.io" /></div>
      <div><label class="note">Branch</label><input id="gh_branch" placeholder="main" /></div>
      <div><label class="note">Jobs file path</label><input id="gh_path" placeholder="data/jobs.json" /></div>
      <div><label class="note">Aspirants file path</label><input id="gh_path_asp" placeholder="data/aspirants.json" /></div>
      <div style="grid-column:1/-1">
        <label class="note">Personal Access Token (contents: read & write). Stored only in this browser.</label>
        <input id="gh_token" type="password" placeholder="ghp_… or fine-grained token" />
      </div>
    </div>
    <div class="toolbar" style="margin-top:10px;justify-content:space-between">
      <div class="toolbar">
        <button id="saveCfg" class="primary">Save</button>
        <button id="testPush">Test read</button>
        <button id="clearCfg" class="danger">Clear token</button>
      </div>
      <span class="note">Token: Settings → Developer settings → Personal access tokens.</span>
    </div>
  </div>
</div>

<script>
(function(){
  const JOBS_URL = 'data/jobs.json';
  const ASP_URL  = 'data/aspirants.json';

  // DOM
  const $ = s => document.querySelector(s);
  const rows=$('#rows'), whoSel=$('#who'), q=$('#q'), statusFilter=$('#statusFilter'),
        upcomingOnly=$('#upcomingOnly'), countNote=$('#countNote'), verNote=$('#verNote'),
        tabs=$('#tabs'), draftNote=$('#draftNote'),
        addBtn=$('#addBtn'), reloadBtn=$('#reload'),
        exportCsvBtn=$('#exportCsv'), exportJsonBtn=$('#exportJson'), exportAspBtn=$('#exportAsp'),
        editModal=$('#editModal'), closeEdit=$('#closeEdit'), modalTitle=$('#modalTitle'),
        settingsBtn=$('#settingsBtn'), settingsModal=$('#settingsModal'), closeSettings=$('#closeSettings');

  const state = {
    // remote files
    allRemote: [], aspRemote: [],
    // composed (apply local changes)
    all: [],
    // filters/sort
    who:'', statusQuick:'', sortKey:'examOn', sortDir:'asc',
    version:'',
    // local change sets
    drafts: load('jt_drafts', []),         // job adds/edits
    deletes: load('jt_deletes', []),       // job deletions (keys)
    aspAdd: load('jt_asp_add', []),        // new aspirant names
    aspDel: load('jt_asp_del', []),        // deleted aspirant names
    // config & edit state
    cfg: load('jt_cfg', {}), currentEditKey:null
  };

  // helpers
  const esc = s => String(s??'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const fmtDate = s => !s ? '—' : new Date(s+'T00:00:00').toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});
  function daysUntil(s){ if(!s) return null; const t0=new Date(); const d=new Date(s+'T00:00:00'); const today=new Date(t0.getFullYear(),t0.getMonth(),t0.getDate()); return Math.round((d-today)/86400000); }
  function badge(n){ if(n===null) return '<span class="badge">—</span>'; if(n<0) return `<span class="badge bad">${Math.abs(n)}d past</span>`; if(n===0) return `<span class="badge warn">Today</span>`; if(n<=7) return `<span class="badge warn">${n}d</span>`; if(n<=30) return `<span class="badge ok">${n}d</span>`; return `<span class="badge">${n}d</span>`; }
  function cmp(a,b,key){ const av=a[key]??'', bv=b[key]??''; if((key==='appliedOn'||key==='examOn')){ if(!av&&!bv) return 0; if(!av) return 1; if(!bv) return -1; } return String(av).localeCompare(String(bv), undefined, {numeric:true, sensitivity:'base'}); }
  const todayISO = ()=> new Date().toISOString().slice(0,10);
  const b64 = s => btoa(unescape(encodeURIComponent(s)));
  const unb64 = s => decodeURIComponent(escape(atob(s)));
  const keyOf = r => [r.name,r.title,r.appliedOn].map(x=>String(x||'').trim().toLowerCase()).join('||');

  function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function load(k,def){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(def)); }catch{ return def; } }

  // load both files
  async function loadData(cacheBust=false){
    const jobsUrl = cacheBust? JOBS_URL+'?v='+Date.now() : JOBS_URL;
    const aspUrl  = cacheBust? ASP_URL +'?v='+Date.now() : ASP_URL;
    // jobs
    let jobs = [];
    try{ const r = await fetch(jobsUrl,{cache:'no-store'}); if(r.ok){ const j=await r.json(); jobs=j.jobs||[]; state.version=j.version||''; } }
    catch(e){ /* ignore until created */ }
    state.allRemote = jobs;
    // aspirants (optional file)
    let asp = [];
    try{ const r = await fetch(aspUrl,{cache:'no-store'}); if(r.ok){ const j=await r.json(); asp=j.aspirants||[]; } }
    catch(e){ /* ignore */ }
    state.aspRemote = asp;
    verNote.textContent = state.version ? ('Data version: '+state.version) : '';
    composeAll(); populateWho(); fromURL(); render();
  }

  function composeAll(){
    // compose jobs
    const map = new Map();
    state.allRemote.forEach(r=> map.set(keyOf(r), r));
    state.drafts.forEach(d=> map.set(keyOf(d), {...d,_draft:true}));
    state.deletes.forEach(k=> map.delete(k));
    state.all = Array.from(map.values());
    updateChangeNote();
  }

  function allAspirantNames(){
    const set = new Set();
    state.aspRemote.forEach(n => set.add(String(n)));
    state.all.forEach(r => r.name && set.add(String(r.name)));
    state.aspAdd.forEach(n => set.add(String(n)));
    state.aspDel.forEach(n => set.delete(String(n)));
    return Array.from(set).filter(Boolean).sort((a,b)=>a.localeCompare(b));
  }

  function populateWho(){
    const names = allAspirantNames();
    const current = state.who || localStorage.getItem('jt_who') || (new URLSearchParams(location.search).get('who')||'');
    // build dropdown with add/delete actions
    let html = '<option value="">— Select aspirant —</option>';
    html += names.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
    html += '<option value="__add__">➕ Add aspirant…</option>';
    if(current) html += '<option value="__del__">🗑 Delete this aspirant…</option>';
    whoSel.innerHTML = html;
    if(names.includes(current)) whoSel.value = current; else if(current) whoSel.value='';
    state.who = whoSel.value;
  }

  function matches(r){
    if(state.who && r.name!==state.who) return false;
    const chosen = state.statusQuick || statusFilter.value;
    if(chosen && r.status!==chosen) return false;
    if(upcomingOnly.checked){ const n=daysUntil(r.examOn); if(n===null || n<0) return false; }
    const term = q.value.trim().toLowerCase();
    if(!term) return true;
    return [r.title,r.org,r.notes].some(v => String(v||'').toLowerCase().includes(term));
  }

  function render(){
    const filtered = state.all.filter(matches).sort((a,b)=> state.sortDir==='asc'?cmp(a,b,state.sortKey): -cmp(a,b,state.sortKey));
    rows.innerHTML = filtered.map(r=>{
      const k = keyOf(r), kenc = encodeURIComponent(k);
      return `<tr>
        <td><div style="font-weight:600">${esc(r.title)}</div>${r._draft? ' <span class="badge warn">draft</span>':''}<div class="note hide-sm">${esc(r.name||'')}</div></td>
        <td class="hide-sm">${esc(r.org||'')}</td>
        <td>${fmtDate(r.appliedOn)}</td>
        <td>${fmtDate(r.examOn)}</td>
        <td>${badge(daysUntil(r.examOn))}</td>
        <td>${esc(r.status||'')}</td>
        <td class="hide-sm">${esc(r.notes||'')}</td>
        <td class="actions">
          <button class="editBtn" data-k="${kenc}">Edit</button>
          <button class="delBtn danger" data-k="${kenc}">Delete</button>
        </td>
      </tr>`;
    }).join('');
    countNote.textContent = `${filtered.length} shown${state.who? ' for '+state.who:''} / ${state.all.length} total`;
    localStorage.setItem('jt_who', state.who||'');
    const usp=new URLSearchParams(location.search); if(state.who) usp.set('who',state.who); else usp.delete('who');
    history.replaceState(null,'',location.pathname+(usp.toString()? '?'+usp : ''));
  }

  function updateChangeNote(){
    const adds = state.drafts.length, dels = state.deletes.length;
    const aAdd = state.aspAdd.length, aDel = state.aspDel.length;
    const parts = [];
    if(adds||dels) parts.push(`${adds} add/edit, ${dels} delete`);
    if(aAdd||aDel) parts.push(`aspirants: +${aAdd} / −${aDel}`);
    draftNote.textContent = parts.length ? `Changes pending — ${parts.join(' | ')}` : '';
  }

  // events
  whoSel.addEventListener('change', ()=>{
    if(whoSel.value==='__add__'){ addAspirantFlow(); return; }
    if(whoSel.value==='__del__'){ deleteAspirantFlow(); return; }
    state.who = whoSel.value; render();
  });
  q.addEventListener('input', render);
  statusFilter.addEventListener('change', ()=>{ state.statusQuick=''; setActiveTab(''); render(); });
  upcomingOnly.addEventListener('change', render);
  document.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{ const k=th.getAttribute('data-key'); if(state.sortKey===k){ state.sortDir=state.sortDir==='asc'?'desc':'asc'; } else { state.sortKey=k; state.sortDir='asc'; } render(); });
  });
  tabs.addEventListener('click',(e)=>{ const b=e.target.closest('button'); if(!b) return; const s=b.getAttribute('data-status')||''; state.statusQuick=s; statusFilter.value=''; setActiveTab(s); render(); });
  function setActiveTab(s){ tabs.querySelectorAll('button').forEach(b=> b.classList.toggle('active',(b.getAttribute('data-status')||'')===s)); }

  // Row actions
  rows.addEventListener('click',(e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const key = decodeURIComponent(btn.dataset.k||'');
    if(btn.classList.contains('editBtn')) return openEdit(key);
    if(btn.classList.contains('delBtn')) return deleteByKey(key);
  });

  // reload / export
  reloadBtn.addEventListener('click', ()=> loadData(true).catch(err=>alert(err.message)));
  exportCsvBtn.addEventListener('click', ()=>{
    const headers=['name','title','org','appliedOn','examOn','status','notes'];
    const items=state.all.filter(matches);
    const csv=[headers.join(',')].concat(items.map(o=>headers.map(h=>'"'+String(o[h]??'').replace(/"/g,'""')+'"').join(','))).join('\n');
    download(new Blob([csv],{type:'text/csv'}),(state.who?state.who+'-':'')+'jobs.csv');
  });
  exportJsonBtn.addEventListener('click', ()=>{
    const merged = mergeJobsForSave(); download(new Blob([JSON.stringify(merged,null,2)],{type:'application/json'}),'jobs.json');
  });
  exportAspBtn.addEventListener('click', ()=>{
    const out = mergeAspirantsForSave(); download(new Blob([JSON.stringify(out,null,2)],{type:'application/json'}),'aspirants.json');
  });

  // Add/Edit Job modal
  addBtn.addEventListener('click', ()=> openAdd());
  closeEdit.addEventListener('click', ()=> show(editModal,false));

  function openAdd(){
    state.currentEditKey=null;
    modalTitle.textContent='Add exam / job';
    setForm({name:state.who||'', org:'', title:'', status:'Applied', appliedOn:todayISO(), examOn:'', notes:''});
    show(editModal,true); $('#m_title').focus();
  }
  function openEdit(key){
    const rec=findByKey(key); if(!rec){ alert('Item not found.'); return; }
    state.currentEditKey=key; modalTitle.textContent='Edit: '+(rec.title||''); setForm(rec); show(editModal,true);
  }
  function setForm(r){ $('#m_name').value=r.name||''; $('#m_org').value=r.org||''; $('#m_title').value=r.title||''; $('#m_status').value=r.status||'Applied'; $('#m_appliedOn').value=r.appliedOn||''; $('#m_examOn').value=r.examOn||''; $('#m_notes').value=r.notes||''; }
  function getForm(){ return { name:$('#m_name').value.trim(), org:$('#m_org').value.trim(), title:$('#m_title').value.trim(), status:$('#m_status').value, appliedOn:$('#m_appliedOn').value, examOn:$('#m_examOn').value, notes:$('#m_notes').value.trim() }; }

  $('#saveDraft').addEventListener('click', ()=>{
    const rec=getForm(); if(!rec.name||!rec.title||!rec.appliedOn){ alert('Please fill Name, Title, and Date applied.'); return; }
    const newKey=keyOf(rec);
    if(state.currentEditKey && state.currentEditKey!==newKey){
      if(!state.deletes.includes(state.currentEditKey)) state.deletes.push(state.currentEditKey);
      save('jt_deletes',state.deletes);
      state.drafts = state.drafts.filter(d=> keyOf(d)!==state.currentEditKey);
    }
    const idx=state.drafts.findIndex(d=> keyOf(d)===newKey);
    if(idx>=0) state.drafts[idx]=rec; else state.drafts.push(rec);
    save('jt_drafts',state.drafts);
    composeAll(); populateWho(); render(); show(editModal,false);
  });

  function deleteByKey(key){
    const rec=findByKey(key); if(!rec) return;
    if(!confirm('Delete this entry?')) return;
    const i=state.drafts.findIndex(d=> keyOf(d)===key);
    if(i>=0){ state.drafts.splice(i,1); save('jt_drafts',state.drafts); }
    else if(!state.deletes.includes(key)){ state.deletes.push(key); save('jt_deletes',state.deletes); }
    composeAll(); render();
  }
  function findByKey(k){ const d=state.drafts.find(x=>keyOf(x)===k); if(d) return {...d,_draft:true}; const r=state.allRemote.find(x=>keyOf(x)===k); return r? {...r}:null; }

  // Aspirant Add/Delete flows
  function addAspirantFlow(){
    const name = prompt('Add aspirant — enter full name:'); if(!name) { populateWho(); return; }
    const clean = name.trim();
    if(!clean) { populateWho(); return; }
    if(allAspirantNames().includes(clean)){ alert('Aspirant already exists.'); populateWho(); whoSel.value=clean; state.who=clean; render(); return; }
    state.aspAdd.push(clean); save('jt_asp_add',state.aspAdd); updateChangeNote(); populateWho(); whoSel.value=clean; state.who=clean; render();
  }
  function deleteAspirantFlow(){
    if(!state.who){ alert('Select an aspirant first.'); populateWho(); return; }
    const name = state.who;
    if(!confirm('Remove “‘+name+’” from the dropdown? (Jobs will be kept.)')){ populateWho(); whoSel.value=name; state.who=name; render(); return; }
    // mark aspirant as deleted
    if(!state.aspDel.includes(name)) state.aspDel.push(name); save('jt_asp_del',state.aspDel);
    // optional: also delete all their jobs
    if(confirm('Also delete ALL jobs for “‘+name+’”? (Cannot be undone unless you reload from GitHub)')){
      // mark each of their jobs deleted
      const keysForName = state.all.map(r=>({r, k:keyOf(r)})).filter(x=>x.r.name===name).map(x=>x.k);
      keysForName.forEach(k=>{
        // remove any draft or add tombstone if remote
        const i=state.drafts.findIndex(d=> keyOf(d)===k);
        if(i>=0) state.drafts.splice(i,1); else if(!state.deletes.includes(k)) state.deletes.push(k);
      });
      save('jt_drafts',state.drafts); save('jt_deletes',state.deletes);
    }
    updateChangeNote(); composeAll(); populateWho(); state.who=''; render();
  }

  // Settings / GitHub
  settingsBtn.addEventListener('click', ()=>{
    show(settingsModal,true);
    $('#gh_owner').value=state.cfg.owner||'';
    $('#gh_repo').value=state.cfg.repo||'';
    $('#gh_branch').value=state.cfg.branch||'main';
    $('#gh_path').value=state.cfg.path||'data/jobs.json';
    $('#gh_path_asp').value=state.cfg.pathAsp||'data/aspirants.json';
    $('#gh_token').value=state.cfg.token||'';
  });
  closeSettings.addEventListener('click', ()=> show(settingsModal,false));
  $('#saveCfg').addEventListener('click', ()=>{ state.cfg={ owner:$('#gh_owner').value.trim(), repo:$('#gh_repo').value.trim(), branch:($('#gh_branch').value.trim()||'main'), path:($('#gh_path').value.trim()||'data/jobs.json'), pathAsp:($('#gh_path_asp').value.trim()||'data/aspirants.json'), token:$('#gh_token').value.trim() }; save('jt_cfg',state.cfg); alert('Saved.'); });
  $('#clearCfg').addEventListener('click', ()=>{ state.cfg={}; save('jt_cfg',state.cfg); alert('Cleared.'); });
  $('#testPush').addEventListener('click', async ()=>{ try{ await ghGetFileMeta(state.cfg.path); await ghGetFileMeta(state.cfg.pathAsp); alert('OK: both files accessible.'); }catch(e){ alert('Check settings/token: '+e.message); } });

  // push both files
  $('#pushGithub').addEventListener('click', pushToGitHub);
  async function pushToGitHub(){
    if(!(state.cfg && state.cfg.token)){ alert('Add GitHub token in Settings first.'); return; }
    try{
      // jobs
      const jobsMeta = await ghGetFileMeta(state.cfg.path).catch(()=>null);
      const jobsMerged = mergeJobsForSave(jobsMeta? JSON.parse(unb64((jobsMeta.content||'').replace(/\n/g,''))) : null);
      await ghPutFile(state.cfg.path, JSON.stringify(jobsMerged,null,2), jobsMeta && jobsMeta.sha);

      // aspirants
      const aspMeta = await ghGetFileMeta(state.cfg.pathAsp).catch(()=>null);
      const aspMerged = mergeAspirantsForSave(aspMeta? JSON.parse(unb64((aspMeta.content||'').replace(/\n/g,''))) : null);
      await ghPutFile(state.cfg.pathAsp, JSON.stringify(aspMerged,null,2), aspMeta && aspMeta.sha);

      // clear local changes
      state.drafts=[]; state.deletes=[]; state.aspAdd=[]; state.aspDel=[];
      save('jt_drafts',state.drafts); save('jt_deletes',state.deletes); save('jt_asp_add',state.aspAdd); save('jt_asp_del',state.aspDel);
      await loadData(true);
      show(editModal,false);
      alert('Pushed jobs + aspirants to GitHub ✔');
    }catch(err){ alert(err.message); }
  }

  function mergeJobsForSave(existing){
    const base = existing || {version:'', jobs:[]};
    const out = { version: new Date().toISOString().slice(0,10), jobs: [] };
    const delset = new Set(state.deletes);
    base.jobs.forEach(r=>{ if(!delset.has(keyOf(r))) out.jobs.push(r); });
    const set = new Set(out.jobs.map(keyOf));
    state.drafts.forEach(d=>{ const k=keyOf(d); if(set.has(k)){ out.jobs = out.jobs.map(r=> keyOf(r)===k? d:r); } else { out.jobs.push(d); set.add(k); } });
    return out;
  }

  function mergeAspirantsForSave(existing){
    const base = existing || {version:'', aspirants:[]};
    const set = new Set((base.aspirants||[]).map(String));
    state.aspAdd.forEach(n=> set.add(String(n)));
    state.aspDel.forEach(n=> set.delete(String(n)));
    return { version: new Date().toISOString().slice(0,10), aspirants: Array.from(set).sort((a,b)=>a.localeCompare(b)) };
  }

  async function ghGetFileMeta(path){
    const url = `https://api.github.com/repos/${state.cfg.owner}/${state.cfg.repo}/contents/${path}?ref=${encodeURIComponent(state.cfg.branch||'main')}`;
    const res = await fetch(url, { headers:{ 'Authorization':'Bearer '+state.cfg.token, 'Accept':'application/vnd.github+json' } });
    if(!res.ok) throw new Error('Fetch failed ('+res.status+') for '+path);
    return res.json();
  }
  async function ghPutFile(path, contentStr, sha){
    const res = await fetch(`https://api.github.com/repos/${state.cfg.owner}/${state.cfg.repo}/contents/${path}`,{
      method:'PUT',
      headers:{ 'Authorization':'Bearer '+state.cfg.token, 'Accept':'application/vnd.github+json' },
      body: JSON.stringify({ message:`Update ${path} via app`, content:b64(contentStr), sha:sha||undefined, branch:state.cfg.branch })
    });
    if(!res.ok){ const t=await res.text(); throw new Error('Write failed for '+path+': '+t); }
  }

  // helpers
  function show(el,on){ el.classList.toggle('show', !!on); }
  function download(blob,name){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); }
  function fromURL(){ const u=new URLSearchParams(location.search); const who=u.get('who'); if(who){ state.who=who; } }

  // init
  document.querySelectorAll('.modal').forEach(m=> m.addEventListener('click', e=>{ if(e.target===m) show(m,false); }));
  loadData().catch(err=>{
    rows.innerHTML = `<tr><td colspan="8">Failed to load data: ${esc(err.message)}. Ensure <code>/data/jobs.json</code> exists.</td></tr>`;
  });
})();
</script>
</body>
</html>
